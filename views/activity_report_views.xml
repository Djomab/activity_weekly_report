<odoo>

    <!-- ================================================= -->
    <!-- VUE RECHERCHE : RAPPORTS -->
    <!-- ================================================= -->
    <record id="view_activity_weekly_report_search" model="ir.ui.view">
        <field name="name">activity.weekly.report.search</field>
        <field name="model">activity.weekly.report</field>
        <field name="arch" type="xml">
            <search>
                <field name="name"/>
                <field name="department_id"/>
                <field name="direction_id"/>
                <field name="week_start"/>
                <field name="week_end"/>
                
                <!-- Filtres par état -->
                <filter string="Brouillon" name="draft" domain="[('state','=','draft')]"/>
                <filter string="Soumis" name="submitted" domain="[('state','=','submitted')]"/>
                <filter string="Validé" name="validated" domain="[('state','=','validated')]"/>
                <filter string="Rejeté" name="rejected" domain="[('state','=','rejected')]"/>
                
                <separator/>
                
                <!-- Filtres par période -->
                <filter string="Cette semaine" name="this_week" 
                        domain="[('week_start','&lt;=', context_today().strftime('%Y-%m-%d')), ('week_end','&gt;=', context_today().strftime('%Y-%m-%d'))]"/>
                <filter string="Semaine dernière" name="last_week" 
                        domain="[('week_start','&gt;=', (context_today()-datetime.timedelta(days=7)).strftime('%Y-%m-%d')), ('week_start','&lt;', context_today().strftime('%Y-%m-%d'))]"/>
                <filter string="Ce mois" name="this_month" 
                        domain="[('week_start','&gt;=', context_today().strftime('%Y-%m-01'))]"/>
                
                <separator/>
                
                <!-- Filtres spéciaux -->
                <filter name="arbitrage"
                    string="Arbitrage requis"
                    domain="[('arbitration_required','=',True), ('state','=','submitted')]"/>
                
                <!-- Groupements -->
                <group expand="0" string="Grouper par">
                    <filter string="Service" name="group_department" context="{'group_by':'department_id'}"/>
                    <filter string="Direction" name="group_direction" context="{'group_by':'direction_id'}"/>
                    <filter string="État" name="group_state" context="{'group_by':'state'}"/>
                    <filter string="Année" name="group_year" context="{'group_by':'year'}"/>
                    <filter string="Semaine de début" name="group_week_start" context="{'group_by':'week_start'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- ================================================= -->
    <!-- VUE LISTE : RAPPORTS -->
    <!-- ================================================= -->
    <record id="view_activity_weekly_report_list" model="ir.ui.view">
        <field name="name">activity.weekly.report.list</field>
        <field name="model">activity.weekly.report</field>
        <field name="arch" type="xml">
            <list decoration-info="state=='draft'" 
                  decoration-warning="state=='submitted'" 
                  decoration-success="state=='validated'" 
                  decoration-danger="state=='rejected'">
                <field name="name"/>
                <field name="department_id"/>
                <field name="direction_id"/>
                <field name="week_start"/>
                <field name="week_end"/>
                <field name="year"/>
                <field name="global_progress" string="% Réalisation"/>
                <field name="arbitration_required" optional="hide"/>
                <field name="state" widget="badge" 
                       decoration-info="state == 'draft'"
                       decoration-warning="state == 'submitted'"
                       decoration-success="state == 'validated'"
                       decoration-danger="state == 'rejected'"/>
            </list>
        </field>
    </record>

    <!-- ================================================= -->
    <!-- VUE FORMULAIRE : RAPPORT -->
    <!-- ================================================= -->
    <record id="view_activity_weekly_report_form" model="ir.ui.view">
        <field name="name">activity.weekly.report.form</field>
        <field name="model">activity.weekly.report</field>
        <field name="arch" type="xml">

            <form string="Rapport d'activité">

                <!-- ================= HEADER ================= -->
                <header>

                    <button name="action_submit"
                            string="Soumettre"
                            type="object"
                            class="btn-primary"
                            invisible="state != 'draft'"/>

                    <button name="action_validate"
                            string="Valider"
                            type="object"
                            class="btn-success"
                            groups="activity_weekly_report.group_activity_report_admin"
                            invisible="state != 'submitted'"/>

                    <button name="action_open_reject_wizard"
                            string="Rejeter"
                            type="object"
                            class="btn-danger"
                            groups="activity_weekly_report.group_activity_report_admin"
                            invisible="state != 'submitted'"/>

                    <button name="action_back_to_draft"
                            string="Repasser en brouillon"
                            type="object"
                            class="btn-warning"
                            invisible="state != 'rejected'"/>

                    <field name="state"
                           widget="statusbar"
                           statusbar_visible="draft,submitted,validated"/>
                </header>

                <sheet>

                    <!-- ================= BANNIÈRE D'ALERTE ================= -->
                    <div class="alert alert-warning" role="alert" invisible="not arbitration_required">
                        <strong>⚠️ Arbitrage DG requis</strong> - Ce rapport nécessite une décision de la Direction Générale.
                    </div>

                    <!-- ================= INFOS GÉNÉRALES ================= -->
                    <group>
                        <group>
                            <field name="department_id"
                                   readonly="state != 'draft'"/>
                            <field name="direction_id" readonly="1"/>
                            <field name="employee_id" readonly="1"/>
                        </group>
                        <group>
                            <field name="week_start"
                                   readonly="state != 'draft'"/>
                            <field name="week_end"
                                   readonly="state != 'draft'"/>
                            <field name="year" readonly="1"/>
                            <label for="global_progress" string="Réalisation globale"/>
                            <div class="o_row">
                                <field name="global_progress" readonly="1" class="oe_inline"/> %
                            </div>
                        </group>
                    </group>

                    <!-- ================= ONGLETS ================= -->
                    <notebook>

                        <!-- ================= ACTIVITÉS ================= -->
                        <page string="Activités réalisées">

                            <field name="line_ids">

                                <list editable="bottom" 
                                      decoration-success="status == 'done'"
                                      decoration-warning="status == 'in_progress'"
                                      decoration-danger="status == 'blocked'"
                                      decoration-muted="status == 'todo'">

                                    <!-- Champ invisible pour conditions -->
                                    <field name="report_id" column_invisible="1"/>
                                    
                                    <field name="name" 
                                           required="1"
                                           readonly="parent.state not in ['draft','rejected']"/>
                                    <field name="date_start"
                                           readonly="parent.state not in ['draft','rejected']"/>
                                    <field name="date_end"
                                           readonly="parent.state not in ['draft','rejected']"/>
                                    <field name="duration" readonly="1"/>
                                    <field name="status" 
                                           required="1"
                                           readonly="parent.state not in ['draft','rejected']"/>
                                    <field name="priority" 
                                           widget="priority"
                                           readonly="parent.state not in ['draft','rejected']"/>

                                    <!-- % RÉALISATION : Modifiable selon l'état du rapport -->
                                    <field name="progress" 
                                           string="% Réalisation"
                                           readonly="parent.state not in ['draft','rejected']"/>

                                </list>
                            </field>
                        </page>

                        <!-- ================= POINTS BLOQUANTS ================= -->
                        <page string="Points bloquants">
                            <group>
                                <field name="blocking_points"
                                       placeholder="Décrivez les difficultés rencontrées, les obstacles ou les retards..."
                                       readonly="state not in ['draft','rejected']"/>
                                <field name="arbitration_required"
                                       readonly="state not in ['draft','rejected']"/>
                            </group>
                        </page>

                        <!-- ================= ACTIONS CORRECTIVES ================= -->
                        <page string="Actions correctives">
                            <field name="corrective_actions"
                                   placeholder="Listez les actions à mettre en place pour résoudre les problèmes identifiés..."
                                   nolabel="1"
                                   readonly="state not in ['draft','rejected']"/>
                        </page>

                    </notebook>
                </sheet>

                <!-- ================= CHATTER ================= -->
                <chatter/>

            </form>
        </field>
    </record>

    <!-- ================================================= -->
    <!-- VUE KANBAN : RAPPORTS (optionnelle) -->
    <!-- ================================================= -->
    <record id="view_activity_weekly_report_kanban" model="ir.ui.view">
        <field name="name">activity.weekly.report.kanban</field>
        <field name="model">activity.weekly.report</field>
        <field name="arch" type="xml">
            <kanban class="o_kanban_mobile" default_group_by="state">
                <field name="name"/>
                <field name="department_id"/>
                <field name="direction_id"/>
                <field name="week_start"/>
                <field name="week_end"/>
                <field name="state"/>
                <field name="global_progress"/>
                <field name="arbitration_required"/>
                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title"><field name="name"/></strong>
                                </div>
                                <span class="badge rounded-pill" 
                                      t-att-class="record.state.raw_value == 'validated' ? 'text-bg-success' : 
                                                   record.state.raw_value == 'submitted' ? 'text-bg-warning' : 
                                                   record.state.raw_value == 'rejected' ? 'text-bg-danger' : 'text-bg-info'">
                                    <field name="state"/>
                                </span>
                            </div>
                            <div class="o_kanban_record_body">
                                <field name="department_id"/>
                                <br/>
                                <i class="fa fa-calendar" title="Période"/> <field name="week_start"/> → <field name="week_end"/>
                                <br/>
                                <div class="mt-2">
                                    <strong>Progression : </strong>
                                    <field name="global_progress"/> %
                                </div>
                            </div>
                            <div class="o_kanban_record_bottom" t-if="record.arbitration_required.raw_value">
                                <span class="badge text-bg-warning">⚠️ Arbitrage DG</span>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <record id="view_activity_report_pivot" model="ir.ui.view">
        <field name="name">activity.weekly.report.pivot</field>
        <field name="model">activity.weekly.report</field>
        <field name="arch" type="xml">
            <pivot>
                <field name="department_id" type="row"/>
                <field name="week_start" type="col"/>
                <field name="id" type="measure"/>
            </pivot>
        </field>
    </record>

</odoo>